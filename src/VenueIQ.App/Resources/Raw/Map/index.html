<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VenueIQ Map</title>
  <style>
    html, body, #exportRoot { height:100%; margin:0; padding:0; }
    #map { height:100%; }
    #legend { position:absolute; top:12px; right:12px; background:rgba(255,255,255,0.9); border-radius:8px; padding:8px 10px; box-shadow:0 2px 6px rgba(0,0,0,0.15); font-family:sans-serif; }
  </style>
  <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.css" />
  <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <div id="exportRoot" aria-label="Map export root" style="position:relative;">
    <div id="map" role="application" aria-label="Azure map"></div>
    <div id="legend" aria-label="Legend">Legend (placeholder)</div>
  </div>
  <script>
    (function(){
      const subKey = '{{API_KEY}}';
      const lang = '{{LANG}}' || 'sr-Latn';
      const center = [parseFloat('{{CENTER_LNG}}'), parseFloat('{{CENTER_LAT}}')];
      const zoom = parseInt('{{ZOOM}}') || 11;

      try {
        const map = new atlas.Map('map', {
          language: lang,
          center: center,
          zoom: zoom,
          authOptions: { authType: 'subscriptionKey', subscriptionKey: subKey }
        });

        map.events.add('ready', () => {
          // Placeholder sources/layers
          window.venueiq = window.venueiq || {};
          window.venueiq.datasource = new atlas.source.DataSource('venueiq-data');
          map.sources.add(window.venueiq.datasource);
          window.venueiq.heatLayer = new atlas.layer.HeatMapLayer(window.venueiq.datasource, 'venueiq-heat', {
            colorGradient: [
              'interpolate', ['linear'], ['heatmap-density'],
              0.0, '#1B4965',
              0.5, '#5FA8D3',
              0.8, '#BEE9E8',
              1.0, '#FFD166'
            ],
            weight: ['get', 'score']
          });
          map.layers.add(window.venueiq.heatLayer);

          // Highlight layer for selection
          window.venueiq.hlSource = new atlas.source.DataSource('venueiq-hl');
          map.sources.add(window.venueiq.hlSource);
          window.venueiq.hlLayer = new atlas.layer.SymbolLayer(window.venueiq.hlSource, 'venueiq-hl-layer', {
            iconOptions: { image: 'marker-blue', allowOverlap: true },
            textOptions: { textField: ['format', ['round', ['get', 'score'], 2]], offset: [0, -2] }
          });
          map.layers.add(window.venueiq.hlLayer);

          window.venueiq.updateHeatmapB64 = function(b64){
            try {
              const json = JSON.parse(atob(b64));
              const feats = json.features || [];
              const shapes = feats.map(f => new atlas.Shape(new atlas.data.Point(f.geometry.coordinates), f.properties));
              window.venueiq.datasource.clear();
              if (shapes.length > 0) {
                window.venueiq.datasource.add(shapes);
              }
              window.location.href = 'app://mapRendered';
            } catch (e) {
              window.location.href = 'app://mapError?' + encodeURIComponent(e.message || 'parse');
            }
          };
          window.venueiq.clearHeatmap = function(){
            window.venueiq.datasource && window.venueiq.datasource.clear();
            window.location.href = 'app://mapRendered';
          };

          window.venueiq.centerOn = function(lon, lat, props){
            try {
              window.venueiq.hlSource.clear();
              const shape = new atlas.Shape(new atlas.data.Point([lon, lat]), props || {});
              window.venueiq.hlSource.add(shape);
              map.setCamera({ center: [lon, lat], zoom: Math.max(map.getCamera().zoom, 14) });
            } catch (e) {
              window.location.href = 'app://mapError?' + encodeURIComponent(e.message || 'center');
            }
          };

          // Notify host app
          window.location.href = 'app://mapReady';

          // Export image: returns base64 (no data URI prefix). format: 'png'|'jpeg'. scale: 1 (standard) or >1 (high-res)
          window.venueiq.exportImage = async function(format, scale){
            try {
              const root = document.getElementById('exportRoot');
              const opt = { backgroundColor: null, scale: Math.max(1, Number(scale) || 1) };
              const canvas = await html2canvas(root, opt);
              const mime = (format === 'jpeg' || format === 'jpg') ? 'image/jpeg' : 'image/png';
              const url = canvas.toDataURL(mime, 0.92);
              return url.split(',')[1];
            } catch (e){
              return 'ERROR:' + (e && e.message ? e.message : 'export');
            }
          };
        });
      } catch (err) {
        const reason = encodeURIComponent((err && err.message) ? err.message : 'unknown');
        window.location.href = 'app://mapError?' + reason;
      }
    })();
  </script>
</body>
</html>
