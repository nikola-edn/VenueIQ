<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:VenueIQ.App.ViewModels"
             xmlns:loc="clr-namespace:VenueIQ.App.Helpers"
             xmlns:controls="clr-namespace:VenueIQ.App.Controls"
             x:Class="VenueIQ.App.Views.MainPage"
             x:DataType="vm:MainViewModel"
             x:Name="MainPageRoot">

    <Grid RowDefinitions="Auto,*" Padding="16">
            <Grid x:Name="HeaderBar" ColumnDefinitions="*,Auto,Auto,Auto" Row="0" Margin="0,0,0,12">
            <Picker x:Name="BusinessTypePicker" AutomationId="Main.BusinessTypePicker"/>
            <Slider Grid.Column="1" x:Name="RadiusSlider" AutomationId="Main.RadiusSlider" Minimum="0.5" Maximum="5" Value="{Binding RadiusKm}"/>
            <Button Grid.Column="2" x:Name="AnalyzeButton" AutomationId="Main.AnalyzeButton" Text="{Binding [Main_Analyze], Source={x:Static loc:LocalizationResourceManager.Instance}}" IsEnabled="{Binding IsAnalyzeEnabled}"/>
            <Button Grid.Column="3" x:Name="ExportButton" AutomationId="Main.ExportButton" Text="{Binding [Export_Heatmap], Source={x:Static loc:LocalizationResourceManager.Instance}}"/>
        </Grid>

        <Grid Row="1" ColumnDefinitions="2*,*" RowDefinitions="Auto,*,Auto" ColumnSpacing="12">
            <Grid>
                <controls:MapWebView x:Name="Map" />
                <Grid x:Name="MapLoadingOverlay" AutomationId="Main.MapLoadingOverlay" BackgroundColor="#66000000" IsVisible="True">
                    <Label Text="{Binding [Main_LoadingMap], Source={x:Static loc:LocalizationResourceManager.Instance}}" HorizontalOptions="Center" VerticalOptions="Center"/>
                </Grid>
            </Grid>
            <!-- Advanced Weights Panel -->
            <Frame Grid.Column="1" Grid.Row="0" Padding="12" HasShadow="True" BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1E1E1E}">
                <VerticalStackLayout Spacing="8">
                    <HorizontalStackLayout Spacing="8" VerticalOptions="Center">
                        <Label Text="{Binding [Main_AdvancedWeights], Source={x:Static loc:LocalizationResourceManager.Instance}}" FontAttributes="Bold" />
                        <Button Text="{Binding [Weights_AutoBalance], Source={x:Static loc:LocalizationResourceManager.Instance}}" Command="{Binding AutoBalanceCommand}" AutomationId="Weights.AutoBalanceButton" />
                        <Label Text="{Binding [Weights_Updating], Source={x:Static loc:LocalizationResourceManager.Instance}}"
                               IsVisible="{Binding IsUpdating}"
                               TextColor="#666"
                               AutomationId="Weights.UpdatingIndicator"/>
                    </HorizontalStackLayout>
                    <Label Text="{Binding StatusMessageKey, Converter={StaticResource ResKeyToTextConverter}}"
                           IsVisible="{Binding StatusMessageKey, Converter={StaticResource StringNotEmptyConverter}}"
                           TextColor="#B71C1C"
                           AutomationId="Weights.StatusMessage" />

                    <!-- Complements -->
                    <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto">
                        <Label Grid.Column="0" Text="{Binding [Weights_Complements], Source={x:Static loc:LocalizationResourceManager.Instance}}"/>
                        <Slider Grid.Column="1" x:Name="ComplementsSlider" Minimum="0" Maximum="100" Value="{Binding WComplementsPercent}" MinimumTrackColor="#2E7D32" ThumbColor="#2E7D32"
                                AutomationId="Weights.ComplementsSlider">
                            <SemanticProperties.Description>
                                <Binding Path="[A11y_Weights_Complements]" Source="{x:Static loc:LocalizationResourceManager.Instance}" />
                            </SemanticProperties.Description>
                        </Slider>
                        <Frame Grid.Column="2" Padding="4" BackgroundColor="#EEEEEE">
                            <Label Text="{Binding WComplementsPercent, StringFormat='{}{0:0}%'}" />
                        </Frame>
                    </Grid>

                    <!-- Accessibility -->
                    <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto">
                        <Label Grid.Column="0" Text="{Binding [Weights_Accessibility], Source={x:Static loc:LocalizationResourceManager.Instance}}"/>
                        <Slider Grid.Column="1" x:Name="AccessibilitySlider" Minimum="0" Maximum="100" Value="{Binding WAccessibilityPercent}" MinimumTrackColor="#1565C0" ThumbColor="#1565C0"
                                AutomationId="Weights.AccessibilitySlider">
                            <SemanticProperties.Description>
                                <Binding Path="[A11y_Weights_Accessibility]" Source="{x:Static loc:LocalizationResourceManager.Instance}" />
                            </SemanticProperties.Description>
                        </Slider>
                        <Frame Grid.Column="2" Padding="4" BackgroundColor="#EEEEEE">
                            <Label Text="{Binding WAccessibilityPercent, StringFormat='{}{0:0}%'}" />
                        </Frame>
                    </Grid>

                    <!-- Demand -->
                    <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto">
                        <Label Grid.Column="0" Text="{Binding [Weights_Demand], Source={x:Static loc:LocalizationResourceManager.Instance}}"/>
                        <Slider Grid.Column="1" x:Name="DemandSlider" Minimum="0" Maximum="100" Value="{Binding WDemandPercent}" MinimumTrackColor="#6A1B9A" ThumbColor="#6A1B9A"
                                AutomationId="Weights.DemandSlider">
                            <SemanticProperties.Description>
                                <Binding Path="[A11y_Weights_Demand]" Source="{x:Static loc:LocalizationResourceManager.Instance}" />
                            </SemanticProperties.Description>
                        </Slider>
                        <Frame Grid.Column="2" Padding="4" BackgroundColor="#EEEEEE">
                            <Label Text="{Binding WDemandPercent, StringFormat='{}{0:0}%'}" />
                        </Frame>
                    </Grid>

                    <!-- Competition -->
                    <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto">
                        <Label Grid.Column="0" Text="{Binding [Weights_Competition], Source={x:Static loc:LocalizationResourceManager.Instance}}"/>
                        <Slider Grid.Column="1" x:Name="CompetitionSlider" Minimum="0" Maximum="100" Value="{Binding WCompetitionPercent}" MinimumTrackColor="#B71C1C" ThumbColor="#B71C1C"
                                AutomationId="Weights.CompetitionSlider">
                            <SemanticProperties.Description>
                                <Binding Path="[A11y_Weights_Competition]" Source="{x:Static loc:LocalizationResourceManager.Instance}" />
                            </SemanticProperties.Description>
                        </Slider>
                        <Frame Grid.Column="2" Padding="4" BackgroundColor="#EEEEEE">
                            <Label Text="{Binding WCompetitionPercent, StringFormat='{}{0:0}%'}" />
                        </Frame>
                    </Grid>
                </VerticalStackLayout>
            </Frame>

            <CollectionView Grid.Column="1" Grid.Row="1"
                            AutomationId="Main.ResultsList"
                            ItemsSource="{Binding Results}"
                            SelectionMode="Single"
                            SelectedItem="{Binding Selected}">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="vm:ResultItemViewModel">
                        <Grid Padding="8" ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto" x:Name="ResultItemRoot">
                            <Grid.AutomationId>
                                <Binding Path="AutomationId" />
                            </Grid.AutomationId>
                            <Label Grid.RowSpan="2" Grid.Column="0" Text="{Binding Rank}" FontAttributes="Bold" />
                            <Label Grid.Column="1" Text="{Binding Score}" />
                            <HorizontalStackLayout Grid.Row="1" Grid.Column="1" Spacing="6">
                                <Label Text="{Binding PrimaryBadgeKey, Converter={StaticResource ResKeyToTextConverter}}" />
                                <CollectionView ItemsSource="{Binding SupportingBadgeKeys}" ItemsLayout="HorizontalList">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Frame Padding="4" BackgroundColor="#EEEEEE">
                                                <Label Text="{Binding ., Converter={StaticResource ResKeyToTextConverter}}" />
                                            </Frame>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </HorizontalStackLayout>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
            <Button Grid.Row="2" Grid.ColumnSpan="2" Text="{Binding [Main_ResetDefaults], Source={x:Static loc:LocalizationResourceManager.Instance}}" AutomationId="Main.ResetDefaultsButton" Command="{Binding ResetDefaultsCommand}" />
        </Grid>
        <!-- Export Dialog Overlay -->
        <Grid x:Name="ExportDialogOverlay" Grid.RowSpan="2" BackgroundColor="#66000000" IsVisible="False" AutomationId="ExportHeatmap.Dialog">
            <Frame Padding="16" CornerRadius="10" HasShadow="True" WidthRequest="520" HorizontalOptions="Center" VerticalOptions="Center" BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2B2B2B}">
                <VerticalStackLayout Spacing="12">
                    <Label Text="{Binding [Export_Dialog_Title], Source={x:Static loc:LocalizationResourceManager.Instance}}" FontAttributes="Bold" FontSize="18" />

                    <Grid ColumnDefinitions="*,*" ColumnSpacing="16">
                        <VerticalStackLayout Grid.Column="0" Spacing="8">
                            <Label Text="{Binding [Export_Format_Label], Source={x:Static loc:LocalizationResourceManager.Instance}}" />
                            <HorizontalStackLayout>
                                <RadioButton x:Name="ExportFormatPng" Content="{Binding [Export_Format_PNG], Source={x:Static loc:LocalizationResourceManager.Instance}}" GroupName="Format" IsChecked="True" />
                                <RadioButton x:Name="ExportFormatJpg" Content="{Binding [Export_Format_JPG], Source={x:Static loc:LocalizationResourceManager.Instance}}" GroupName="Format" />
                            </HorizontalStackLayout>
                            <Label Text="{Binding [Export_Resolution_Label], Source={x:Static loc:LocalizationResourceManager.Instance}}" />
                            <HorizontalStackLayout>
                                <RadioButton x:Name="ExportResStandard" Content="{Binding [Export_Resolution_Standard], Source={x:Static loc:LocalizationResourceManager.Instance}}" GroupName="Resolution" IsChecked="True" />
                                <RadioButton x:Name="ExportResHigh" Content="{Binding [Export_Resolution_High], Source={x:Static loc:LocalizationResourceManager.Instance}}" GroupName="Resolution" />
                            </HorizontalStackLayout>
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Column="1" Spacing="6">
                            <Label Text="{Binding [Export_Preview], Source={x:Static loc:LocalizationResourceManager.Instance}}" />
                            <Frame Padding="0" BorderColor="#DDD" BackgroundColor="#FFF" HeightRequest="180">
                                <Image x:Name="ExportPreviewImage" Aspect="AspectFill"/>
                            </Frame>
                        </VerticalStackLayout>
                    </Grid>

                    <Label x:Name="ExportProgressLabel" TextColor="#666" IsVisible="False" />

                    <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8">
                        <Label Grid.Column="0" />
                        <Button Grid.Column="1" x:Name="CancelExportButton" Text="{Binding [Export_Cancel], Source={x:Static loc:LocalizationResourceManager.Instance}}" />
                        <Button Grid.Column="2" x:Name="SaveExportButton" AutomationId="ExportHeatmap.SaveButton" Text="{Binding [Export_Save], Source={x:Static loc:LocalizationResourceManager.Instance}}" />
                    </Grid>
                </VerticalStackLayout>
            </Frame>
        </Grid>
    </Grid>

</ContentPage>
