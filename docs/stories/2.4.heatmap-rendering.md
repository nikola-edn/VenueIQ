# Story 2.4: Heatmap Rendering Pipeline

## Status
Ready for Dev

## Story
**As a** VenueIQ analyst,
**I want** to see a heatmap overlay that reflects computed opportunity scores on the map,
**so that** I can visually identify promising locations at a glance.

## Acceptance Criteria
1. MainViewModel must transform `CellScore` results into GeoJSON (or equivalent structure) and send them to `MapWebView` using the established JS bridge.
2. The heatmap layer shall use the brand-defined gradient (`#1B4965 → #5FA8D3 → #BEE9E8 → #FFD166`) with opacity/weighting tied to normalized scores.
3. Updates must be debounced to avoid flooding the WebView; only the latest analysis or weight-change result should render, and the UI should show loading state during updates.
4. Provide fallback visualization (e.g., remove layer, show banner) when no cells meet threshold or data is empty, preventing stale overlays.
5. Ensure the map layer cleans up previous sources when new analyses run to avoid memory leaks; support manual refresh triggered by Analyze command and weight adjustments.
6. Tests: integration test verifying GeoJSON payload structure and layer update, UI automation ensuring heatmap layer appears/disappears properly, unit test confirming debounce behaviour.
7. Display the heatmap legend chip and intensity labels (Serbian + English) described in `docs/front-end-spec.md#62-main-analysis-screen`, keeping legend synchronized with current gradient scale.
8. Provide accessibility affordances: announce heatmap refresh via `SemanticScreenReader`, ensure legend is keyboard focusable, and expose colorblind-friendly toggle stub (even if placeholder) to satisfy UX roadmap.

## Tasks / Subtasks
- [ ] Data transformation (AC: 1)
  - [ ] Map `CellScore` collection to GeoJSON FeatureCollection with required properties (score, CI/CoI/AI/DI) (AC: 1)
  - [ ] Include top factor strings in properties for future tooltips (AC: 1)
- [ ] JS bridge update (AC: 1-5)
  - [ ] Add JS function to ingest GeoJSON, update heatmap layer, and remove old sources (AC: 1,5)
  - [ ] Support clearing layer when dataset empty (AC: 4)
  - [ ] Emit callback when render completes to trigger screen reader announcement (AC: 8)
- [ ] ViewModel coordination (AC: 2-5)
  - [ ] Debounce updates (reuse weights debounce) and manage loading indicator (AC: 3)
  - [ ] Trigger map refresh on Analyze completion and weight changes (AC: 5)
  - [ ] Toggle legend visibility + update gradient labels when new data arrives (AC: 7)
  - [ ] Surface accessibility toggle stub bound to future colorblind modes (AC: 8)
- [ ] Styling & thresholds (AC: 2,4)
  - [ ] Apply gradient + intensity scaling consistent with design spec (AC: 2)
  - [ ] Define minimum score threshold for display, fallback message on no data (AC: 4)
  - [ ] Populate legend text and value markers using localized resources (AC: 7)
- [ ] Testing (AC: 6)
  - [ ] Unit tests verifying GeoJSON serializer (AC: 6)
  - [ ] Integration test with mocked WebView verifying update/clear sequence (AC: 6)
  - [ ] UI test ensuring heatmap toggles with analysis execution (AC: 6)

## Dev Notes
- Consult `docs/ui-architecture.md` sections 7 & 9 for heatmap gradient and UX behaviours.
- Keep payload size manageable; consider trimming to top N cells if necessary (but include comment for future tuning).
- Ensure JS code is idempotent; re-registering layer should recycle previous instances rather than duplicating.
- For loading states, reuse toasts or inline spinner overlay defined in Story 1.2.
- Provide instrumentation (timing) to assist Story 2.5 when list updates rely on same data.
- Mirror legend layout, typography, and chip styling from `docs/front-end-spec.md` so UI matches design deliverables; include automation IDs (`Main.HeatmapLegend`, `Main.HeatmapColorblindToggle`).
- Coordinate with accessibility guidelines to provide textual summary of score range (e.g., "Top opportunities shading from navy to gold").
- Ensure fallback state removes legend to avoid confusing empty map scenarios.

### Testing
- Tests belong beside earlier Map stories; follow `docs/architecture/13-test-strategy.md` coverage guidance.
- For UI automation, verify gradient presence by checking DOM/injected script results if accessible, or rely on success callback.
- Manual QA: run on emulator, confirm heatmap updates when adjusting weights; ensure clearing occurs when radius shrinks to zero results.
- Include accessibility test verifying legend is reachable via keyboard and announcements fire post-render (AC: 7-8).
- Capture screenshot baseline (manual/automated) for heatmap + legend to support visual regression monitoring.

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-10-07 | 0.1 | Initial draft | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
