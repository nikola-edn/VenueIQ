# Story 2.4: Heatmap Rendering Pipeline

## Status
Implemented (awaiting build/test on MAUI host)

## Story
**As a** VenueIQ analyst,
**I want** to see a heatmap overlay that reflects computed opportunity scores on the map,
**so that** I can visually identify promising locations at a glance.

## Acceptance Criteria
1. MainViewModel must transform `CellScore` results into GeoJSON (or equivalent structure) and send them to `MapWebView` using the established JS bridge.
2. The heatmap layer shall use the brand-defined gradient (`#1B4965 → #5FA8D3 → #BEE9E8 → #FFD166`) with opacity/weighting tied to normalized scores.
3. Updates must be debounced to avoid flooding the WebView; only the latest analysis or weight-change result should render, and the UI should show loading state during updates.
4. Provide fallback visualization (e.g., remove layer, show banner) when no cells meet threshold or data is empty, preventing stale overlays.
5. Ensure the map layer cleans up previous sources when new analyses run to avoid memory leaks; support manual refresh triggered by Analyze command and weight adjustments.
6. Tests: integration test verifying GeoJSON payload structure and layer update, UI automation ensuring heatmap layer appears/disappears properly, unit test confirming debounce behaviour.
7. Display the heatmap legend chip and intensity labels (Serbian + English) described in `docs/front-end-spec.md#62-main-analysis-screen`, keeping legend synchronized with current gradient scale.
8. Provide accessibility affordances: announce heatmap refresh via `SemanticScreenReader`, ensure legend is keyboard focusable, and expose colorblind-friendly toggle stub (even if placeholder) to satisfy UX roadmap.

## Tasks / Subtasks
- [x] Data transformation (AC: 1)
  - [x] Map `CellScore` to GeoJSON FeatureCollection with properties (score, CI, CoI, AI, DI)
- [x] JS bridge update (AC: 1-5)
  - [x] Add JS functions `updateHeatmapB64` and `clearHeatmap`; reuse single DataSource/HeatMapLayer; emit `app://mapRendered`
- [x] View coordination (AC: 2-5)
  - [x] Debounce via CTS; show overlay during render; trigger on Analyze
  - [ ] Wire weight-change debounce in next story (3.1)
- [x] Styling & thresholds (AC: 2,4)
  - [x] Apply gradient per spec; weight from `score`
  - [ ] Min threshold + legend labels (TODO)
- [ ] Testing (AC: 6)
  - [x] Unit test for grid/engine exists; add GeoJSON serializer tests later
  - [ ] WebView integration/UI tests pending on host

## Dev Notes
- Consult `docs/ui-architecture.md` sections 7 & 9 for heatmap gradient and UX behaviours.
- Keep payload size manageable; consider trimming to top N cells if necessary (but include comment for future tuning).
- Ensure JS code is idempotent; re-registering layer should recycle previous instances rather than duplicating.
- For loading states, reuse toasts or inline spinner overlay defined in Story 1.2.
- Provide instrumentation (timing) to assist Story 2.5 when list updates rely on same data.
- Mirror legend layout, typography, and chip styling from `docs/front-end-spec.md` so UI matches design deliverables; include automation IDs (`Main.HeatmapLegend`, `Main.HeatmapColorblindToggle`).
- Coordinate with accessibility guidelines to provide textual summary of score range (e.g., "Top opportunities shading from navy to gold").
- Ensure fallback state removes legend to avoid confusing empty map scenarios.

### Testing
- Tests belong beside earlier Map stories; follow `docs/architecture/13-test-strategy.md` coverage guidance.
- For UI automation, verify gradient presence by checking DOM/injected script results if accessible, or rely on success callback.
- Manual QA: run on emulator, confirm heatmap updates when adjusting weights; ensure clearing occurs when radius shrinks to zero results.
- Include accessibility test verifying legend is reachable via keyboard and announcements fire post-render (AC: 7-8).
- Capture screenshot baseline (manual/automated) for heatmap + legend to support visual regression monitoring.

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-10-07 | 0.1 | Initial draft | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

- dev (James)
### Debug Log References

- WSL environment; tested transformation paths; WebView render validated on host is pending.
### Completion Notes List

- Added GeoJSON builder for `CellScore` collections with score and per-index properties.
- Extended Map HTML with venueiq namespace, update/clear handlers, and color gradient per UX.
- MapWebView exposes `UpdateHeatmapAsync` and `ClearHeatmapAsync`, plus a `HeatmapRendered` event for accessibility announcement.
- MainPage wires Analyze button to run analysis and update the heatmap; overlay shows during render; announces update afterward.
### File List

- src/VenueIQ.App/Utils/GeoJsonHelper.cs
- src/VenueIQ.App/Controls/MapWebView.xaml.cs (updated)
- src/VenueIQ.App/Resources/Raw/Map/index.html (updated)
- src/VenueIQ.App/Services/MapAnalysisService.cs (returns CellDetails)
- src/VenueIQ.Core/Models/Dtos.cs (add CellDetails)
- src/VenueIQ.App/Views/MainPage.xaml.cs (wire Analyze + updates)
## QA Results
