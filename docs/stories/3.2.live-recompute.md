# Story 3.2: Live Recompute on Weight Adjustments

## Status
Ready for Dev

## Story
**As a** VenueIQ analyst adjusting factor weights,
**I want** the heatmap and ranked list to update automatically after I tweak sliders,
**so that** I can immediately see how weighting changes impact recommended locations.

## Acceptance Criteria
1. When a weight slider value changes, `MainViewModel` must debounce updates (150–250 ms) and trigger recomputation using cached POIs without additional Azure Maps calls.
2. Debounced recomputation shall invoke `MapAnalysisService`/`ScoreCalculator` with new weights and refresh both heatmap overlay (Story 2.4) and ranked list (Story 2.5) in sync.
3. During recomputation, show a subtle "Updating…" indicator near sliders or list header, and disable further Analyze button presses until update completes.
4. If a recomputation is in progress and new changes occur, cancel the in-flight task and process only the latest weight state (latest wins).
5. Handle error scenarios gracefully: if recompute fails (e.g., lack of cached POIs), display inline message prompting rerun of full analysis; log error for diagnostics.
6. Tests: unit tests ensuring debounce/cancel behavior, integration tests verifying no additional POI calls, UI tests ensuring heatmap/list update after weight change and indicator visibility.
7. Indicator and messaging must follow UX styling (`docs/front-end-spec.md#8-states--feedback`): bilingual microcopy, subtle progress pulse, and screen-reader friendly status updates without causing announcement spam.
8. Maintain focus/selection context after recompute (selected result remains highlighted, sliders retain focus) and ensure `SemanticScreenReader.Announce` summarizes outcome when assistive tech is active.
9. Support motion-reduced mode by skipping indicator animations and providing alternative static feedback while still meeting timing requirements (<600 ms fade per UX spec).

## Tasks / Subtasks
- [x] Debounce infrastructure (AC: 1,4)
  - [x] Implement cancellation token logic in `MainViewModel` for weight changes (AC: 4)
  - [x] Set debounce interval constant consistent with UX spec (AC: 1)
- [x] Recompute pipeline (AC: 1-2)
  - [x] Reuse cached POIs from `PoiSearchService` (Story 2.2) (AC: 1-2)
  - [x] Invoke `MapAnalysisService` with updated weights, update `CellScore` collection (AC: 2)
- [ ] UI feedback (AC: 3)
  - [x] Display "Updating…" indicator with localization support (AC: 3)
  - [ ] Manage button enabled state and slider busy status (AC: 3)
  - [ ] Integrate indicator visuals/animations per UX spec, include reduce-motion fallback (AC: 7,9)
- [x] Error handling (AC: 5)
  - [x] Catch recompute exceptions, display toast/banner with guidance (AC: 5)
  - [x] Provide fallback to rerun full analysis if cache missing (AC: 5)
  - [x] Emit localized status/ARIA messages and maintain selection focus (AC: 7-8)
- [ ] Testing (AC: 6)
  - [ ] Unit tests verifying debounce + latest wins logic (AC: 6)
  - [ ] Integration test confirming no new API calls by spying on `PoiSearchService` (AC: 6)
  - [ ] UI automation verifying indicator toggles and both heatmap/list refresh (AC: 6)
  - [ ] Accessibility test validating announcements, focus retention, and reduce-motion path (AC: 7-9)
  - [ ] Visual regression capturing indicator states (idle, updating, error) (AC: 3,7)

## Dev Notes
- Weight change workflow described in `docs/architecture/8-core-workflows.md#82-weight-change-flow`; ensure implementation matches sequence.
- Use `AsyncRelayCommand` or custom async method with `CancellationTokenSource` per change event.
- Keep recomputation on background thread but marshal updates to main thread for UI binding.
- Ensure localization keys for "Updating…" and error messages exist per Story 1.4.
- Maintain instrumentation to measure recompute duration; consider telemetry hook for future performance tuning.
- Mirror indicator placement and microcopy from `docs/front-end-spec.md` (e.g., inline pill near Advanced Weights header) and document animation specs (pulse amplitude, duration).
- Provide guidance for screen reader announcements (use polite queue) and restore focus to previously focused element post-refresh.
- Capture telemetry for recompute frequency and duration to feed UX analytics dashboard (optional TODO for future story).

### Testing
- Place tests under `VenueIQ.Tests/ViewModels/MainViewModelWeightsTests.cs` or similar following `docs/architecture/13-test-strategy.md`.
- For integration tests, inject mock `PoiSearchService` verifying no HTTP calls; use deterministic test data from Story 2.3.
- Manual QA: adjust sliders repeatedly to confirm latest state wins, watch CPU usage on mobile to ensure smooth experience.
- Manual UX verification: confirm indicator placement matches spec, copy is bilingual, animations respect reduce-motion, and screen reader announcements occur once per recompute.

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-10-07 | 0.1 | Initial draft | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

- dev (James)
### Debug Log References

- See `.ai/debug-log.md` (WSL dev env; build/run on host MAUI machine).
### Completion Notes List

- Added cached recompute path in `MapAnalysisService` (`RecomputeAsync`) avoiding new POI calls; stores last grid and POIs.
- Implemented debounced weight-change handling in `MainViewModel` with cancellation (latest-wins) and `IsUpdating` state.
- Wired `WeightsRecomputed` event to update heatmap in `MainPage`; announced start/end via `SemanticScreenReader`.
- Displayed localized "Updating…" indicator; disabled Analyze while updating; preserved selection across refreshes.
- Added localized status keys for updating and error prompts.
- Added test validating POI client caching for identical requests.
### File List

- src/VenueIQ.App/Services/MapAnalysisService.cs
- src/VenueIQ.App/ViewModels/MainViewModel.cs
- src/VenueIQ.App/Views/MainPage.xaml
- src/VenueIQ.App/Views/MainPage.xaml.cs
- src/VenueIQ.App/Resources/Strings/AppResources.resx
- src/VenueIQ.App/Resources/Strings/AppResources.sr-Latn.resx
- tests/VenueIQ.Tests/Services/PoiSearchClientCacheTests.cs
## QA Results
