# Story 2.3: Sampling Grid & Score Calculation

## Status
Ready for Dev

## Story
**As a** VenueIQ analyst,
**I want** VenueIQ to evaluate the analysis area using a normalized scoring model,
**so that** competition, demand, accessibility, and complements inform the opportunity heatmap.

## Acceptance Criteria
1. `MapAnalysisService` shall generate a hex or grid sampling pattern covering the selected radius, producing geo-coordinates for each cell with adjustable resolution based on radius (per architecture guidance).
2. Service must gather POI collections from `PoiSearchService`, compute indexes for Competition (CI), Complements (CoI), Accessibility (AI), and Demand (DI) using distance-decay kernels defined in `docs/architecture/6-components.md` and `docs/ui-architecture.md`.
3. Implement `ScoreCalculator` functions that normalize each index (0-1 range) and compute final weighted score using current slider weights, returning `CellScore` DTOs with per-index values and top contributing factors.
4. Provide safeguards for sparse data (e.g., fallback when no complements found) and ensure calculations do not throw when API returns zero results.
5. Performance: analysis should complete within PRD target (≤10s) for radius ≤2 km; include instrumentation to log duration and flag if thresholds exceeded.
6. Tests: unit tests validating scoring math, normalization, and weight influence; integration test ensuring pipeline handles empty and dense POI inputs within performance envelope (mock timings acceptable).
7. Expose UX-facing descriptors with `CellScore` (e.g., `PrimaryBadge`, `SupportingBadges`, `RationaleTokens`, `CoverageConfidence`) so Stories 2.4/2.5 can render badges and rationale exactly as defined in `docs/front-end-spec.md#62-main-analysis-screen` and `#65-rationale-detail-pane`.
8. Provide threshold metadata indicating when warnings should surface (e.g., low data coverage, high competition) and link to resource keys for localized banners.

## Tasks / Subtasks
- [ ] Sampling strategy implementation (AC: 1)
  - [ ] Create helper to generate grid/hex coordinates with adjustable spacing (AC: 1)
  - [ ] Document constants and allow future tuning via configuration (AC: 1)
- [ ] Index computation (AC: 2)
  - [ ] Calculate CI using competitor POIs + decay kernel `exp(-d/300)` (AC: 2)
  - [ ] Calculate CoI, AI, DI using respective inputs/decays (AC: 2)
- [ ] ScoreCalculator functions (AC: 3-4)
  - [ ] Normalize indexes to 0-1 range, handle zero denominators (AC: 3-4)
  - [ ] Compose final score = weighted sum (AC: 3)
  - [ ] Determine top factor rationale entries (e.g., strings summarizing influences) (AC: 3)
  - [ ] Populate badge descriptors and coverage metadata for UI (AC: 7-8)
- [ ] Integration in `MapAnalysisService` (AC: 2-5)
  - [ ] Fetch POIs via Story 2.2 service, run calculation, return list of `CellScore` (AC: 2-3)
  - [ ] Log start/end time and raise warning if duration exceeds threshold (AC: 5)
  - [ ] Attach resource keys / severity levels for UX banners when thresholds breached (AC: 8)
- [ ] Testing (AC: 6)
  - [ ] Unit tests for each index computation and normalization (AC: 6)
  - [ ] Integration test verifying pipeline with fixture datasets (AC: 6)
  - [ ] Performance guard test (e.g., ensure loops scale reasonably) (AC: 5-6)

## Dev Notes
- Refer to data models in `docs/architecture/5-data-models.md` and workflows in `docs/architecture/8-core-workflows.md`.
- Use vector math utilities to compute distances; prefer Haversine or Azure Maps helpers.
- Consider parallelization or incremental results if needed, but keep initial implementation simple and deterministic.
- Top factor rationale strings should later feed story 2.5; store descriptive metadata (e.g., "High demand: 12 schools within 500m").
- Keep CPU usage reasonable for mobile; avoid generating overly dense grid (start with ~250 cells for 2 km as guideline from architecture discussions).
- Align output payload with UX spec fields (score pill values, badge states, descriptive tokens) to avoid view-side transformations.
- Document rationale token patterns for copywriters (e.g., `{metric}:{value}:{unit}`) so localization stays manageable.
- Consider shaping data for accessibility (e.g., include `AriaSummary` string summarizing major factors per cell).

### Testing
- Locate tests under `VenueIQ.Tests/Services/MapAnalysisServiceTests.cs` and `VenueIQ.Tests/Services/ScoreCalculatorTests.cs` following patterns in `docs/architecture/13-test-strategy.md`.
- Provide fixture data sets: dense urban area, sparse rural area, no complements scenario.
- Manual QA: run analysis on sample coordinates (Belgrade center) ensuring runtime < 10s and results vary when adjusting weights.
- Add assertions ensuring badge metadata, rationale tokens, and coverage flags match expected thresholds (AC: 7-8).
- Include regression test verifying localization keys emitted for warnings correspond to known values (fail if missing).

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-10-07 | 0.1 | Initial draft | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
