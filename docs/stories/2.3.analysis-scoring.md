# Story 2.3: Sampling Grid & Score Calculation

## Status
Implemented (awaiting build/test on MAUI host)

## Story
**As a** VenueIQ analyst,
**I want** VenueIQ to evaluate the analysis area using a normalized scoring model,
**so that** competition, demand, accessibility, and complements inform the opportunity heatmap.

## Acceptance Criteria
1. `MapAnalysisService` shall generate a hex or grid sampling pattern covering the selected radius, producing geo-coordinates for each cell with adjustable resolution based on radius (per architecture guidance).
2. Service must gather POI collections from `PoiSearchService`, compute indexes for Competition (CI), Complements (CoI), Accessibility (AI), and Demand (DI) using distance-decay kernels defined in `docs/architecture/6-components.md` and `docs/ui-architecture.md`.
3. Implement `ScoreCalculator` functions that normalize each index (0-1 range) and compute final weighted score using current slider weights, returning `CellScore` DTOs with per-index values and top contributing factors.
4. Provide safeguards for sparse data (e.g., fallback when no complements found) and ensure calculations do not throw when API returns zero results.
5. Performance: analysis should complete within PRD target (≤10s) for radius ≤2 km; include instrumentation to log duration and flag if thresholds exceeded.
6. Tests: unit tests validating scoring math, normalization, and weight influence; integration test ensuring pipeline handles empty and dense POI inputs within performance envelope (mock timings acceptable).
7. Expose UX-facing descriptors with `CellScore` (e.g., `PrimaryBadge`, `SupportingBadges`, `RationaleTokens`, `CoverageConfidence`) so Stories 2.4/2.5 can render badges and rationale exactly as defined in `docs/front-end-spec.md#62-main-analysis-screen` and `#65-rationale-detail-pane`.
8. Provide threshold metadata indicating when warnings should surface (e.g., low data coverage, high competition) and link to resource keys for localized banners.

## Tasks / Subtasks
- [x] Sampling strategy implementation (AC: 1)
  - [x] Helper to generate grid coordinates with adjustable spacing (AC: 1)
  - [x] Constants documented in code; tuning via parameters (AC: 1)
- [x] Index computation (AC: 2)
  - [x] CI via competitor POIs + kernel `exp(-d/300)` (AC: 2)
  - [x] CoI via complements `exp(-d/200)`; AI/DI derived from complements by category with fallbacks (AC: 2)
- [x] ScoreCalculator functions (AC: 3-4)
  - [x] Min-max normalization with zero-range guard (AC: 3-4)
  - [x] Weighted sum scoring using existing weights (AC: 3)
  - [x] Basic badge/rationale tokens scaffolding (AC: 3,7)
  - [ ] Expand rationale tokens per UX copy deck (TODO) (AC: 7)
- [x] Integration in `MapAnalysisService` (AC: 2-5)
  - [x] Fetch POIs via IPoiSearchClient, run calculation, return heatmap cells + top results (AC: 2-3)
  - [ ] Telemetry threshold warnings (TODO) (AC: 5,8)
- [x] Testing (AC: 6)
  - [x] Unit tests for grid and empty-data handling (AC: 6)
  - [ ] Performance/integration tests (pending; add fixtures later) (AC: 5-6)

## Dev Notes
- Refer to data models in `docs/architecture/5-data-models.md` and workflows in `docs/architecture/8-core-workflows.md`.
- Use vector math utilities to compute distances; prefer Haversine or Azure Maps helpers.
- Consider parallelization or incremental results if needed, but keep initial implementation simple and deterministic.
- Top factor rationale strings should later feed story 2.5; store descriptive metadata (e.g., "High demand: 12 schools within 500m").
- Keep CPU usage reasonable for mobile; avoid generating overly dense grid (start with ~250 cells for 2 km as guideline from architecture discussions).
- Align output payload with UX spec fields (score pill values, badge states, descriptive tokens) to avoid view-side transformations.
- Document rationale token patterns for copywriters (e.g., `{metric}:{value}:{unit}`) so localization stays manageable.
- Consider shaping data for accessibility (e.g., include `AriaSummary` string summarizing major factors per cell).

### Testing
- Locate tests under `VenueIQ.Tests/Services/MapAnalysisServiceTests.cs` and `VenueIQ.Tests/Services/ScoreCalculatorTests.cs` following patterns in `docs/architecture/13-test-strategy.md`.
- Provide fixture data sets: dense urban area, sparse rural area, no complements scenario.
- Manual QA: run analysis on sample coordinates (Belgrade center) ensuring runtime < 10s and results vary when adjusting weights.
- Add assertions ensuring badge metadata, rationale tokens, and coverage flags match expected thresholds (AC: 7-8).
- Include regression test verifying localization keys emitted for warnings correspond to known values (fail if missing).

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-10-07 | 0.1 | Initial draft | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

- dev (James)
### Debug Log References

- WSL environment; scoring implemented in Core to enable tests without MAUI.
### Completion Notes List

- Added Core `AnalysisEngine` with grid generation, index computation, normalization, and score composition.
- Introduced `CellScore` and `Weights` models; badges and rationale tokens scaffolded.
- Updated App `MapAnalysisService` to consume `IPoiSearchClient`, run engine, and return heatmap cells and top results.
- Added basic unit tests validating grid within radius and no-data handling.
### File List

- src/VenueIQ.Core/Services/AnalysisEngine.cs
- src/VenueIQ.Core/Models/AnalysisModels.cs (CellScore, Weights)
- src/VenueIQ.App/Services/MapAnalysisService.cs (updated)
- tests/VenueIQ.Tests/Services/AnalysisEngineTests.cs
## QA Results
