# Story 1.3: Persist User Preferences

## Status
Implemented (awaiting build/test on MAUI host)

## Story
**As a** returning VenueIQ analyst,
**I want** my language, radius, and weighting preferences to persist between sessions,
**so that** I can continue analysis without reconfiguring the app every time.

## Acceptance Criteria
1. The application shall persist the most recent language choice (Serbian Latin or English) using platform preferences.
2. The most recent analysis radius selection must persist and repopulate the slider on next launch.
3. Advanced weighting slider values must persist and restore on next launch, including default values when none are stored.
4. Preferences must load during app startup prior to rendering the Main screen so UI controls reflect stored values immediately.
5. Provide a "Reset to Defaults" control that restores language (Serbian), radius (2 km), and weighting defaults defined in architecture appendix.
6. Validation includes unit tests ensuring `SettingsService` read/write logic and integration/UI tests verifying restoration on relaunch.
7. Hydrated preferences must update all visual summaries defined in `docs/front-end-spec.md#62-main-analysis-screen` (header chips, slider value badges, Settings recap cards) without requiring additional interaction.
8. Reset interaction must show localized confirmation feedback (toast + inline note) and announce the state change via `SemanticScreenReader.Announce` for accessibility compliance.

## Tasks / Subtasks
- [x] Extend `SettingsService` for preferences persistence (AC: 1-5)
  - [x] Implement async getters/setters for language, radius, weights using `Preferences` (AC: 1-3)
  - [x] Ensure sensible defaults from `docs/architecture/16-appendix.md` (AC: 3,5)
- [x] Update `StartupViewModel` / `MainViewModel` to hydrate state (AC: 2-4)
  - [x] Load preferences before binding to UI controls (AC: 4)
  - [x] Wire reset command to defaults (AC: 5)
- [x] UI adjustments (AC: 1-5)
  - [x] Add "Reset to Defaults" affordance in Main page (AC: 5)
  - [x] Persist language toggle value in Settings screen (AC: 1)
  - [x] Bind Radius slider to stored value and hydrate on load (AC: 2-4,7)
  - [x] Implement Reset confirmation announcement via SemanticScreenReader (AC: 5,8)
- [ ] Tests (AC: 6)
  - [ ] Unit tests for `SettingsService` serialization/deserialization (AC: 6)
  - [ ] ViewModel tests covering hydration and reset logic (AC: 6)
  - [ ] UI/automation test verifying restoration after simulated relaunch (AC: 6)

## Dev Notes
- Reference preference defaults and weight configuration in `docs/architecture/16-appendix.md#161-default-weights` and `docs/ui-architecture.md` sections on Localization and Responsive behaviour.
- Keep persistence keys centralized in `SettingsService` to avoid duplication; document them for QA.
- Language toggle should update `LocalizationService` (see `docs/architecture/6-components.md`) and immediately persist preference.
- Reset command should reapply defaults both in service store and live-bound ViewModel state, ensuring slider visuals update.
- Maintain thread safety when reading `SecureStorage` and `Preferences`â€”prefer awaiting in startup pipeline before navigation.
- Reference microcopy, toast tone, and chip layout guidance in `docs/front-end-spec.md#8-states--feedback` and `docs/front-end-spec.md#65-rationale-detail-pane` to keep persisted summaries consistent with UX expectations.
- When updating UI state from preferences, animate slider/thumb movements using MAUI `Easing.SinOut` to reinforce state change without disorienting users.
- Ensure Reset CTA is positioned with secondary emphasis and includes confirmation dialog on desktop form factors as noted in the UX flow.

### Testing
- Follow `docs/architecture/13-test-strategy.md` for unit/integration layering.
- Unit tests can run with in-memory preference abstraction; consider injecting mock `IPreferences` interface for determinism.
- UI test: start app with stored values, assert UI reflects stored settings, invoke reset, confirm defaults set and persisted.
- Add regression test verifying language toggle updates resource manager and persists across navigation.
- Accessibility test: validate `SemanticScreenReader` announcements fire after Reset and language change, and ensure summary chips expose updated `AutomationId` values (AC: 7-8).

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-10-07 | 0.1 | Initial draft | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

- dev (James)
### Debug Log References

- WSL environment; no build/run here. Preferences implemented with MAUI `Preferences` and `SecureStorage`.
### Completion Notes List

- Implemented preferences in `SettingsService` (language, radius, weights, reset).
- `MainViewModel` binds `RadiusKm` and weight fields; persists on change; provides `ResetDefaultsCommand` with accessibility announcement.
- `MainPage` binds slider to `RadiusKm` and adds Reset button.
- `SettingsViewModel` hydrates and persists language; calls `LocalizationService.SetCulture`.
- `SettingsPage` binds language picker to `Languages` and `Language`.
- `AppShell` loads language preference at startup before navigation.
### File List

- src/VenueIQ.App/Services/SettingsService.cs
- src/VenueIQ.App/ViewModels/MainViewModel.cs
- src/VenueIQ.App/Views/MainPage.xaml
- src/VenueIQ.App/Views/MainPage.xaml.cs
- src/VenueIQ.App/ViewModels/SettingsViewModel.cs
- src/VenueIQ.App/Views/SettingsPage.xaml
- src/VenueIQ.App/Views/SettingsPage.xaml.cs
- src/VenueIQ.App/AppShell.xaml.cs
## QA Results
