# Story 1.2: Startup API Key Entry

## Status
Implemented (awaiting build/test on MAUI host)

## Story
**As a** new VenueIQ user,
**I want** to enter and validate my Azure Maps API key when I first open the app,
**so that** I can securely unlock the analysis experience with confidence that my credentials work.

## Acceptance Criteria
1. On first launch when no API key is stored, the app must display the Startup screen blocking navigation until a valid key is provided.
2. The Startup screen shall present a masked API key input and a "Test & Save" action that validates the key against Azure Maps Search API.
3. Successful validation must persist the key using `SecureStorage` and navigate directly to the Main analysis screen.
4. Failed validation must present an inline error state, keep the form active, and avoid storing the key.
5. Subsequent launches with a stored key must bypass the Startup screen and load the Main analysis screen automatically.
6. Unit and integration tests cover validation success, validation failure, and bypass behaviour.
7. Startup screen must implement the four visual states defined in `docs/front-end-spec.md#61-startup-screen` (idle, validating with progress affordance, success confirmation, error with actionable guidance) with localized copy.
8. Form controls require tactile/keyboard focus rings, semantic labels, and automation IDs (`Startup.ApiKeyEntry`, `Startup.TestAndSaveButton`, etc.) to satisfy accessibility and UI test hooks.

## Tasks / Subtasks
- [x] Design Startup flow state handling (AC: 1-5)
  - [x] Detect stored key on app start and branch navigation (AC: 1,5)
  - [x] Implement `IsBusy` guard to prevent duplicate submissions (AC: 2-4)
- [x] Build API key entry UI (AC: 1-4)
  - [x] Create `StartupPage` XAML layout with masked `Entry` and CTA (AC: 1-2)
  - [x] Add validation feedback visuals (success/error banners) (AC: 3-4)
  - [x] Implement behaviors for idle/validating/success/error, including progress indicators (AC: 2-4,7)
  - [x] Wire automation IDs per UX spec (AC: 8)
- [x] Implement `StartupViewModel` logic (AC: 2-5)
  - [x] Inject `SettingsService` + `PoiSearchService` for validation call (AC: 2-3)
  - [x] Handle navigation to Main via `Shell` routing (AC: 3,5)
- [x] Persist credentials securely (AC: 3)
  - [x] Store key via `SecureStorage` and confirm retrieval (AC: 3,5)
- [ ] Automated tests (AC: 6)
  - [ ] Unit tests for `StartupViewModel` covering success/failure paths (AC: 6)
  - [ ] Integration/UI test ensuring Startup shows when no key stored (AC: 1,5)

## Dev Notes
- Arch references: see component responsibilities in `docs/architecture/6-components.md` (Startup page/service stack) and source tree layout in `docs/architecture/9-source-tree.md`.
- `SettingsService` owns secure persistence of API key and preferences; ensure it exposes async get/set methods as single source of truth.
- Key validation should reuse Azure Maps Search API via `PoiSearchService`. A lightweight "Test Connection" query (e.g., category search with min threshold) is sufficient—respect debounce/timeout guidance in `docs/architecture/7-external-apis-azure-maps.md`.
- Navigation flow aligns with MAUI Shell design in `docs/ui-architecture.md` section "Navigation Shell".
- Error messaging should leverage localization keys (Serbian default) defined in the localization story—stub keys now, story 1.4 will populate translations.
- Follow layout, spacing, and tone guidance in `docs/front-end-spec.md#61-startup-screen`; ensure copy blocks use the provided Serbian strings and mirror English translations.
- Provide contextual help link to Azure Maps key documentation in secondary text, styled as subtle link, to support first-time users per UX persona research.
- Maintain focus order: banner → entry → CTA; return focus to entry on validation failure to streamline keyboard flow.

### Testing
- Follow unit test structure from `docs/architecture/13-test-strategy.md` (xUnit + FluentAssertions).
- Place ViewModel tests under `Tests/ViewModels/StartupViewModelTests.cs` with Arrange-Act-Assert pattern.
- Create UI test case in MAUI UITest harness verifying Startup gating behaviour; mock SecureStorage via dependency injection per architecture guidance.
- Include negative test for invalid key response simulating Azure Maps 401/403.
- Add automated visual regression snapshot (or manual QA checklist) covering all four Startup states and verifying localized copy + focus outlines (AC: 7-8).

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-10-07 | 0.1 | Initial draft | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

- dev (James)
### Debug Log References

- See `.ai/debug-log.md` if present; WSL environment used (no run/build here).
### Completion Notes List

- Implemented Startup gating in `AppShell` `Loaded` handler.
- Added `StartupViewModel` with `TestAndSaveCommand`, busy/success/error states.
- `SettingsService` now uses `SecureStorage` to persist/retrieve API key.
- `PoiSearchService` includes `TestApiKeyAsync` calling Azure Maps Search endpoint.
- `StartupPage` wired to VM; UI includes masked entry, progress, success/error banners, automation IDs.
- Added DI access via `ServiceHost` helper and registered services in `MauiProgram`.
- Navigation on success redirects to `//Main`.
### File List

- src/VenueIQ.App/Services/SettingsService.cs
- src/VenueIQ.App/Services/PoiSearchService.cs
- src/VenueIQ.App/ViewModels/StartupViewModel.cs
- src/VenueIQ.App/Views/StartupPage.xaml
- src/VenueIQ.App/Views/StartupPage.xaml.cs
- src/VenueIQ.App/AppShell.xaml.cs
- src/VenueIQ.App/MauiProgram.cs
- src/VenueIQ.App/Helpers/ServiceHost.cs
- src/VenueIQ.App/Utils/AsyncCommand.cs
## QA Results
