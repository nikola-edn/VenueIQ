# Story 5.2: Result Detail Tooltips with Distances

## Status
Ready for Dev

## Story
**As a** VenueIQ analyst,
**I want** to view detailed tooltips for each recommended location showing nearby POIs and distances,
**so that** I can justify why a location ranks highly or poorly.

## Acceptance Criteria
1. Selecting or hovering a result (depending on platform interaction model) must display a detail tooltip/panel containing top competitors and complements with their names, categories, and distance in meters.
2. Tooltip content shall also include quick metrics (e.g., nearest transit distance, demand index explanation) using localized strings and units.
3. Tooltips must appear within 150 ms of selection, positioned contextually near the result card on desktop and as expandable panel on mobile per UX spec.
4. Accessibility: tooltips must be reachable via keyboard focus, provide dismiss controls, and expose content through screen reader description.
5. Update tooltip content in sync with recompute results; if data unavailable, display meaningful fallback messaging rather than stale info.
6. Tests: unit tests for tooltip data formatting and distance conversions, UI automation verifying tooltip visibility timing and platform-specific rendering, accessibility test ensuring focus order and announcements.
7. Tooltip visuals/behaviours must align with `docs/front-end-spec.md#52-result-detail-tooltips`: include bilingual heading, factor badges summary, and CTA links (e.g., "Open in Maps") while ensuring 200 ms fade/slide animation and reduce-motion support.
8. Ensure tooltips reuse descriptor data from badges/ScoreCalculator (`PrimaryMetricValue`, `CoverageConfidence`) and expose automation IDs (`Results.Tooltip.Desktop`, `Results.Tooltip.Mobile`), ARIA roles (`dialog` or `tooltip`), and polite screen reader announcements.
9. Implement safe positioning with collision detection to avoid clipping on small screens; provide scrollable content area when POI lists exceed viewport, keeping close button persistently accessible.

## Tasks / Subtasks
- [x] UI component implementation (AC: 1-4)
  - [x] Build `ResultTooltip` control; desktop vs mobile AutomationId set; mobile expand via toggle (AC: 1,3)
  - [x] Integrate with result items; Toggle via button; keyboard focus lands on Close (AC: 4)
  - [x] Apply 200 ms fade/slide; placeholder reduce-motion toggle; CTA Open in Maps wired (AC: 7-9)
- [x] Data-binding logic (AC: 1-5)
  - [x] Extend `CellScore` with nearest complements/competitors + nearest access distance (AC: 1-2)
  - [x] Add `NearbyPoiViewModel` with localized distance text (AC: 2)
  - [x] Refresh content on recompute through `SetResults` mapping (AC: 5)
  - [x] Reuse badge descriptors for summary (AC: 8)
- [x] Accessibility & localization (AC: 2,4)
  - [x] Resource keys for tooltip headings/CTA (EN/SR-Latn) (AC: 2)
  - [x] Focus to Close button on open; screen reader announce (AC: 4)
  - [x] Automation IDs; role described via SemanticProperties.Description; scrollable lists (AC: 8-9)
- [ ] Testing (AC: 6)
  - [ ] Unit tests for distance formatting and visibility timing (AC: 6)
  - [ ] UI tests for selection/hover behavior and accessibility (AC: 6)
  - [ ] Visual/positioning validation; collision handling remains basic as content is inline (AC: 7-9)

## Dev Notes
- UX guidance located in `docs/front-end-spec.md` sections 5.2 and 7; ensure mobile vs desktop behavior matches specification.
- Use `Popup` or custom overlay component for desktop; on mobile, reuse detail pane pattern defined for results.
- Distances should use `LocalizationService` for decimal separators and unit translations.
- Provide extension points for future analytics (e.g., how often tooltips viewed).
- Document CTA copy, icon usage, and link behaviour (e.g., deep link to navigation app) per UX/PM input.
- Coordinate with localization for length of descriptions to prevent overflow; consider multi-line truncation with "view more" if needed.
- Note behaviour when results list is virtualized (ensure tooltip attaches to visible item even after scroll).

### Testing
- Place tests alongside result list tests from Story 2.5 to reuse fixtures.
- Manual QA: verify tooltip positioning on multiple screen sizes, ensure content updates when weights change.
- Manual UX sweep: validate animations, CTA actions, accessibility behaviours, and reduce-motion fallback on desktop + mobile.

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-10-07 | 0.1 | Initial draft | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

- dev (James)
### Debug Log References

- Implemented tooltip control and wired Open in Maps CTA; extended AnalysisEngine to surface nearest POIs and metrics per cell; updated bindings and localization.
### Completion Notes List

- Added `ResultTooltip` with badges summary, nearest transit metric, and top complements/competitors with names/categories/distances.
- Extended `CellScore` to include nearest POIs and nearest access distance; `AnalysisEngine` now tracks and attaches nearest items per cell during scoring.
- `ResultItemViewModel` exposes `IsTooltipOpen`, toggle command, nearest lists, and formatted distance; DataTemplate renders tooltip inline and toggles via info button.
- Accessibility: focus shifts to Close; screen reader announces open; AutomationId set based on device idiom (Desktop/Mobile).
- CTA: bound to `MainViewModel.OpenInMapsCommand`; page centers map on request.
- TODO: full hover behavior on desktop (current toggle button), robust collision detection, and comprehensive tests.
### File List

- src/VenueIQ.Core/Models/AnalysisModels.cs
- src/VenueIQ.Core/Services/AnalysisEngine.cs
- src/VenueIQ.App/ViewModels/ResultItemViewModel.cs
- src/VenueIQ.App/ViewModels/MainViewModel.cs
- src/VenueIQ.App/Controls/ResultTooltip.xaml
- src/VenueIQ.App/Controls/ResultTooltip.xaml.cs
- src/VenueIQ.App/Views/MainPage.xaml
- src/VenueIQ.App/Views/MainPage.xaml.cs
- src/VenueIQ.App/Resources/Strings/AppResources.resx
- src/VenueIQ.App/Resources/Strings/AppResources.sr-Latn.resx
## QA Results
