# Story 2.2: POI Fetching for Competitors & Complements

## Status
Ready for Dev

## Story
**As a** VenueIQ analyst,
**I want** the engine to retrieve relevant competitor and complementary POIs from Azure Maps,
**so that** scoring can factor nearby businesses accurately for each analysis.

## Acceptance Criteria
1. `PoiSearchService` shall accept `AnalysisInput` context and retrieve POIs for both competitor and complementary category sets defined in `Assets/categories.serbia.json`.
2. Service must call Azure Maps Search Category API with correct parameters (language, radius, pagination) and respect throttling via retry/backoff; failures must translate into structured error results.
3. Results must normalize into internal DTOs (`PoiSummary`) containing name, category, distance, coordinates, and type (competitor/complement).
4. Implement in-memory caching scoped to current session keyed by business type + center + radius to avoid redundant calls during weight recomputation.
5. Provide instrumentation hooks for API latency and error rates (stubbed logging acceptable) to support future monitoring.
6. Tests: unit tests covering request construction, mapping, caching behaviour; integration test using mocked HTTP handler to assert throttling/backoff logic.
7. Service responses must include summary metadata for UI use (e.g., counts per POI type, coverage confidence, partial/failure reasons) so Main screen can display banners defined in `docs/front-end-spec.md#8-states--feedback`.
8. Localize error and empty-state strings by returning resource keys (e.g., `DataWarning_PartialResults`) rather than raw text, enabling downstream localization stories.

## Tasks / Subtasks
- [ ] Extend `Assets/categories.serbia.json` loader if needed (AC: 1)
  - [ ] Validate mappings align with PRD categories (AC: 1)
- [ ] Implement Azure Maps client wrapper (AC: 1-3)
  - [ ] Build request builder respecting language and radius constraints (AC: 2)
  - [ ] Parse JSON response into `PoiSummary` collections (AC: 3)
  - [ ] Populate metadata object with totals, coverage confidence, and warning codes (AC: 7-8)
- [ ] Add caching layer (AC: 4)
  - [ ] Cache success responses per key combination with configurable TTL (AC: 4)
  - [ ] Invalidate cache when business type or radius changes (AC: 4)
- [ ] Error and telemetry handling (AC: 2,5)
  - [ ] Capture HTTP error codes and map to domain errors (AC: 2)
  - [ ] Log metrics stub (count/time) for future instrumentation (AC: 5)
  - [ ] Map partial/failure scenarios to UX-friendly resource keys + severity levels (banner vs toast) (AC: 7-8)
- [ ] Testing (AC: 6)
  - [ ] Unit tests with mocked `HttpMessageHandler` verifying query strings & mapping (AC: 6)
  - [ ] Cache behaviour tests ensuring hits vs misses (AC: 6)
  - [ ] Integration test simulating throttling (429) and verifying retry/backoff (AC: 2,6)

## Dev Notes
- API details documented in `docs/architecture/7-external-apis-azure-maps.md`; follow rate limit recommendations.
- Use `HttpClientFactory` pattern registered in `MauiProgram.cs`; allow dependency injection for tests.
- Consider `Polly` for retry/backoff if available; otherwise implement exponential delay with jitter.
- Caching can leverage `MemoryCache` (via `Microsoft.Extensions.Caching.Memory`) or simple dictionary with timestamp since app is client-only.
- Ensure localization parameter `language=sr-Latn` or `en` depending on preference (tie into Stories 1.3/1.4).
- Provide metadata structure aligning with UX needs (counts for competitor/complement badges, flags for "limited data" callouts) documented in `docs/front-end-spec.md#65-rationale-detail-pane`.
- Surface instrumentation hook that forwards severity to toast/banner pipeline so user feedback stays consistent with UX guidelines.
- Document any API fallback thresholds so UX writers can craft appropriate copy.

### Testing
- Reference testing strategy in `docs/architecture/13-test-strategy.md`; place tests under `VenueIQ.Tests/Services/PoiSearchServiceTests.cs`.
- Use fixture data replicating Azure Maps response; include negative case for malformed payload.
- Manual verification: run app with debugger to inspect API requests and caching (simulate repeated analyses).
- Add tests confirming metadata flags set correctly for partial results, and that localization keys map to expected enum values (AC: 7-8).
- Conduct manual QA scenario where API throttling triggers warning banner to ensure copy surfaces via Main screen per UX spec.

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-10-07 | 0.1 | Initial draft | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
