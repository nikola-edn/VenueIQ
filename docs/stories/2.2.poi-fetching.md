# Story 2.2: POI Fetching for Competitors & Complements

## Status
Implemented (awaiting build/test on MAUI host)

## Story
**As a** VenueIQ analyst,
**I want** the engine to retrieve relevant competitor and complementary POIs from Azure Maps,
**so that** scoring can factor nearby businesses accurately for each analysis.

## Acceptance Criteria
1. `PoiSearchService` shall accept `AnalysisInput` context and retrieve POIs for both competitor and complementary category sets defined in `Assets/categories.serbia.json`.
2. Service must call Azure Maps Search Category API with correct parameters (language, radius, pagination) and respect throttling via retry/backoff; failures must translate into structured error results.
3. Results must normalize into internal DTOs (`PoiSummary`) containing name, category, distance, coordinates, and type (competitor/complement).
4. Implement in-memory caching scoped to current session keyed by business type + center + radius to avoid redundant calls during weight recomputation.
5. Provide instrumentation hooks for API latency and error rates (stubbed logging acceptable) to support future monitoring.
6. Tests: unit tests covering request construction, mapping, caching behaviour; integration test using mocked HTTP handler to assert throttling/backoff logic.
7. Service responses must include summary metadata for UI use (e.g., counts per POI type, coverage confidence, partial/failure reasons) so Main screen can display banners defined in `docs/front-end-spec.md#8-states--feedback`.
8. Localize error and empty-state strings by returning resource keys (e.g., `DataWarning_PartialResults`) rather than raw text, enabling downstream localization stories.

## Tasks / Subtasks
- [x] Extend `Assets/categories.serbia.json` to include competitor/complement sets and loader (AC: 1)
- [x] Implement Azure Maps client wrapper (`IPoiSearchClient`) (AC: 1-3)
  - [x] Build request builder with language/radius and minimal pagination (AC: 2)
  - [x] Parse JSON into `PoiSummary` collections (AC: 3)
  - [x] Populate metadata counts + warning/error keys (AC: 7-8)
- [x] Add caching layer via `IMemoryCache` with TTL (AC: 4)
- [x] Error and telemetry stubs (AC: 2,5)
  - [x] Map HTTP/timeout/unknown to resource keys (AC: 2,8)
  - [x] Log timing and errors to ILogger (stub) (AC: 5)
- [ ] Testing scaffolding (AC: 6)
  - [ ] Unit/integration tests (pending) using mocked HttpMessageHandler (AC: 6)

## Dev Notes
- API details documented in `docs/architecture/7-external-apis-azure-maps.md`; follow rate limit recommendations.
- Use `HttpClientFactory` pattern registered in `MauiProgram.cs`; allow dependency injection for tests.
- Consider `Polly` for retry/backoff if available; otherwise implement exponential delay with jitter.
- Caching can leverage `MemoryCache` (via `Microsoft.Extensions.Caching.Memory`) or simple dictionary with timestamp since app is client-only.
- Ensure localization parameter `language=sr-Latn` or `en` depending on preference (tie into Stories 1.3/1.4).
- Provide metadata structure aligning with UX needs (counts for competitor/complement badges, flags for "limited data" callouts) documented in `docs/front-end-spec.md#65-rationale-detail-pane`.
- Surface instrumentation hook that forwards severity to toast/banner pipeline so user feedback stays consistent with UX guidelines.
- Document any API fallback thresholds so UX writers can craft appropriate copy.

### Testing
- Reference testing strategy in `docs/architecture/13-test-strategy.md`; place tests under `VenueIQ.Tests/Services/PoiSearchServiceTests.cs`.
- Use fixture data replicating Azure Maps response; include negative case for malformed payload.
- Manual verification: run app with debugger to inspect API requests and caching (simulate repeated analyses).
- Add tests confirming metadata flags set correctly for partial results, and that localization keys map to expected enum values (AC: 7-8).
- Conduct manual QA scenario where API throttling triggers warning banner to ensure copy surfaces via Main screen per UX spec.

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-10-07 | 0.1 | Initial draft | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

- dev (James)
### Debug Log References

- WSL environment; service implemented in Core to enable unit tests independent of MAUI.
### Completion Notes List

- Added `IPoiSearchClient` in Core with `PoiSearchClient` implementation using `HttpClient`, `IAzureMapsAuthProvider`, and `IPoiCategoryMapProvider`.
- Implemented session cache via `IMemoryCache` keyed by business type + center + radius + language.
- Normalized results to `PoiSummary` including coordinates, category and distance; metadata includes counts and partial/warning keys.
- Error handling maps to resource keys (e.g., `DataError_Timeout`, `DataWarning_PartialResults`).
- App implements `CategoryMapProvider` to read `Assets/categories.serbia.json` and `AzureMapsAuthProvider` using `SecureStorage` key.
- Registered DI: `AddMemoryCache`, category/auth providers, and `AddHttpClient<IPoiSearchClient, PoiSearchClient>()`.
### File List

- src/VenueIQ.Core/Models/AnalysisModels.cs
- src/VenueIQ.Core/Services/IPoiSearchClient.cs
- src/VenueIQ.Core/Services/PoiSearchClient.cs
- src/VenueIQ.Core/Services/IAzureMapsAuthProvider.cs
- src/VenueIQ.Core/Services/IPoiCategoryMapProvider.cs
- src/VenueIQ.App/Assets/categories.serbia.json
- src/VenueIQ.App/Services/CategoryMapProvider.cs
- src/VenueIQ.App/Services/AzureMapsAuthProvider.cs
- src/VenueIQ.App/MauiProgram.cs
 - tests/VenueIQ.Tests/Services/PoiSearchClientTests.cs
## QA Results
