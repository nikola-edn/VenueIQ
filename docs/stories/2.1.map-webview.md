# Story 2.1: Map WebView Wrapper & Base Layers

## Status
Ready for Dev

## Story
**As a** VenueIQ analyst,
**I want** the Main screen to render an interactive Azure Maps canvas inside the app,
**so that** I can visualize the analysis area before any heatmap or results overlay appears.

## Acceptance Criteria
1. Implement a reusable `MapWebView` control that hosts the Azure Maps Web Control using the user's API key and default Serbian language, centering on the last-used coordinates (or Belgrade fallback).
2. The control must expose initialization and lifecycle hooks (`InitializeAsync`, `OnMapReady`) so `MainViewModel` can await a "map ready" signal before sending heatmap data.
3. Load base map layers (road + labels) and pre-register empty data source/layer placeholders for heatmap and pins without rendering actual data yet (placeholders prove wiring).
4. Support responsive resizing: map fills available space on desktop split view and stacks correctly on mobile; handle orientation changes without script errors.
5. Propagate critical errors (invalid key, script load failure) back to the ViewModel for user messaging while avoiding app crashes; surface telemetry hooks for future logging.
6. Tests: UI smoke test ensures map boots with placeholder layer; integration/unit test confirms handshake contract (ready message) and error propagation path.
7. Display the loading/empty-state overlay defined in `docs/front-end-spec.md#62-main-analysis-screen` until the ready event fires, including localized copy and automation ID (`Main.MapLoadingOverlay`).
8. Provide pinch/zoom, keyboard navigation, and screen reader descriptions per accessibility guidance; expose `SemanticProperties.Description` and focusable elements for map interactions (ACR aligned with WCAG 2.1 AA).
9. Render the static legend toggle and map controls wrapper stubs outlined in the UX spec so future stories can plug in heatmap gradients without reworking layout.

## Tasks / Subtasks
- [ ] Create embedded HTML/JS asset for Azure Maps (AC: 1-3)
  - [ ] Bundle Azure Maps script, configure authentication via query key (AC: 1)
  - [ ] Define JS bridge to send `mapReady`, `mapError`, and resize notifications (AC: 2,5)
- [ ] Implement `MapWebView` control (AC: 1-5)
  - [ ] Derive from `WebView`, load local HTML asset, expose `InitializeAsync` (AC: 1-2)
  - [ ] Provide methods for injecting API key, center/zoom, placeholder datasource/layer (AC: 1-3)
  - [ ] Handle `SizeChanged` to trigger JS resize routine (AC: 4)
  - [ ] Surface automation IDs, semantic descriptions, and command bindings for accessibility + UITest hooks (AC: 8)
- [ ] MainPage wiring (AC: 2,4)
  - [ ] Inject control into XAML layout with proper grid responsiveness (AC: 4)
  - [ ] Subscribe to ready/error callbacks and route to `MainViewModel` (AC: 2,5)
  - [ ] Show/hide loading overlay and empty state panel per UX spec (AC: 7)
  - [ ] Add placeholder legend/controls container matching layout hierarchy (AC: 9)
- [ ] Error handling & telemetry hooks (AC: 5)
  - [ ] Surface errors via messenger/toast pipeline (AC: 5)
  - [ ] Add TODO comments for future logging integration (AC: 5)
- [ ] Testing (AC: 6)
  - [ ] UI test verifying map renders placeholder layer without exceptions (AC: 6)
  - [ ] Unit/integration test mocking JS bridge to confirm ready/error messaging (AC: 6)

## Dev Notes
- Reference Azure Maps integration guidance in `docs/ui-architecture.md` (sections 7 & 9) and component overview in `docs/architecture/6-components.md`.
- HTML asset should live under `Resources/Raw/Map/index.html` (or equivalent) with localized strings for map controls when possible.
- Coordinate with `SettingsService` to supply language `sr-Latn` by default; consider future English toggle.
- Use `WebView2` specific tweaks on Windows and `WKWebView` on Apple platforms; see MAUI docs for enabling hybrid message handlers.
- Provide safe default center (Belgrade coordinates) until analysis flow sets center; read defaults from `AppConstants` when added.
- Mirror structure/spacing from `docs/front-end-spec.md` (Sections 6.2 & 8) including overlay tone, legend placement, and map padding around safe areas.
- Ensure focus order flows from header controls → legend toggle → map surface; when errors occur, shift focus to inline banner for immediate feedback.
- Annotate HTML with ARIA roles (`application`, `region`, `status`) and ensure fallback message appears when WebView fails to load.

### Testing
- Follow UI testing approach in `docs/architecture/13-test-strategy.md`; ensure Windows UI test harness can mock API key.
- Provide mock JS bridge for unit testing handshake logic; consider `IMapWebViewBridge` abstraction to avoid platform dependencies.
- Add manual test checklist: verify map loads on Windows + Android emulator with placeholder layers, check resizing when toggling between orientations.
- Add accessibility QA step confirming screen reader announces map availability and legend toggle, and keyboard users can reach map controls (AC: 8-9).
- Capture visual regression snapshots (or manual capture) of loading overlay and empty state to guard against layout regressions (AC: 7-9).

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-10-07 | 0.1 | Initial draft | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
