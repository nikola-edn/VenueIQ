# Story 4.1: Export Heatmap View as PNG/JPG

## Status
Ready for Dev

## Story
**As a** VenueIQ analyst,
**I want** to export the current map view with its heatmap overlay as an image,
**so that** I can share visual insights with stakeholders outside the app.

## Acceptance Criteria
1. Provide an Export dialog accessible from the Main screen that lets users choose PNG or JPG format and resolution (standard, high-res) for the current heatmap viewport.
2. Export must capture the exact map view (including heatmap layer, legend if visible) without UI chrome such as panels or buttons.
3. Export operation shall run asynchronously, showing progress feedback and preventing duplicate exports until completion.
4. On success, save the image to platform-appropriate location (e.g., local file picker) and display confirmation with file path; on failure, surface actionable error messaging.
5. Generated image metadata should include timestamp, business type, radius, and weight configuration embedded in file name or optional overlay footer.
6. Tests: unit/integration tests verifying capture service, format selection, metadata inclusion; UI tests ensuring export dialog flows and success/error states.
7. Export dialog must follow UX spec (`docs/front-end-spec.md#64-export-dialogs`): bilingual copy, preview thumbnail, resolution helper text, and accessibility-friendly focus order with `AutomationId` hooks (`ExportHeatmap.Dialog`, etc.).
8. Provide optional watermark/footer overlay design approved by UX (Serbian primary copy, English secondary) and ensure color contrast remains ≥4.5:1 when overlaid on map imagery.
9. Support reduce-motion and screen reader flows: announce progress/status via `SemanticScreenReader`, avoid flashing transitions, and provide fallback static messaging if preview unavailable.

## Tasks / Subtasks
- [x] Export UI (AC: 1-4)
  - [x] Add export entry point (button/menu) on Main screen (AC: 1)
  - [x] Build modal dialog with format/resolution options and summary details (AC: 1)
  - [x] Include preview thumbnail, bilingual helper copy, and UX-defined focus order/automation IDs (AC: 7)
- [x] Capture implementation (AC: 2-5)
  - [x] Extend `ExportService` to capture WebView snapshot with heatmap overlay (AC: 2)
  - [x] Strip surrounding UI elements, ensure heatmap layer fully rendered (AC: 2)
  - [x] Incorporate metadata into file name/optional footer overlay (AC: 5) — implemented in filename
  - [ ] Apply optional watermark/footer with approved styling and contrast (AC: 8)
- [x] Asynchronous workflow (AC: 3-4)
  - [x] Run export on background thread, show progress indicator (AC: 3)
  - [x] Handle success/failure notifications with localized messages (AC: 4)
  - [x] Announce status changes for assistive tech and respect reduce-motion setting (AC: 9)
- [ ] Platform-specific storage (AC: 4)
  - [ ] Use MAUI file picker/save dialogs per platform (AC: 4) — currently saves to AppDataDirectory
  - [ ] Confirm permissions/entitlements documented for mobile platforms (AC: 4)
- [ ] Testing (AC: 6)
  - [x] Unit tests for ExportService verifying metadata and format handling (AC: 6)
  - [ ] Integration test simulating WebView capture (AC: 6)
  - [ ] UI automation ensuring dialog flow and progress indicator (AC: 6)
  - [ ] Accessibility test confirming focus order, announcements, and contrast requirements (AC: 7-9)
  - [ ] Visual regression/snapshot of preview + watermark to guard against layout drift (AC: 7-8)

## Dev Notes
- Consult `docs/architecture/6-components.md` ExportService responsibilities and UI spec in `docs/front-end-spec.md` section 6.4.
- MAUI WebView snapshot may require platform-specific rendering (e.g., `Screenshot` API, `WebView.CaptureAsync`); document differences and ensure heatmap JS layer is stable before capture (use `mapReady` events).
- For metadata overlay, consider optional small footer area or embed EXIF-like info; ensure design team approves visual treatment.
- Ensure localization for dialog copy and notifications per Story 1.4.
- Document storage paths and permissions in README or setup doc for QA reference.
- Use UX-provided iconography for export action and dialog (e.g., download glyph) and ensure alignment with motion/microcopy guidelines.
- Provide fallback text if preview fails to render ("Preview unavailable, export will capture current map") with localized resources.
- Coordinate with QA on acceptable tolerance for preview vs final output differences (e.g., due to map tiles re-fetching).

### Testing
- Follow `docs/architecture/13-test-strategy.md`; add integration tests using mock WebView component.
- Manual QA: validate export on Windows, Android, iOS. Confirm heatmap matches on-screen view and file contains metadata.
- Manual UX check: verify dialog layout, preview fidelity, watermark contrast, and accessibility behaviours across languages.

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-10-07 | 0.1 | Initial draft | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

- dev (James)
### Debug Log References

- WSL dev env; export capture via html2canvas in WebView; storage to AppDataDirectory. Build/run on MAUI host.
### Completion Notes List

- Added Export button and modal dialog with PNG/JPG + standard/high-res options, preview, and automation IDs.
- Implemented `MapWebView.CaptureImageAsync` calling new JS `venueiq.exportImage` (html2canvas) to capture map + legend without UI chrome.
- `ExportService.ExportHeatmapAsync` saves capture and embeds metadata (business, radius, weights, timestamp) in filename.
- Added localized copy for dialog, progress, and success/error messages; announced status via `SemanticScreenReader`.
- Prevented duplicate exports by disabling the Save button during operation.
- Added unit test validating filename metadata/extension logic.
- TODO: Integrate platform save pickers (Windows/Android/iOS), watermark/footer overlay with UX-approved styling, and automated UI/integration tests.
### File List

- src/VenueIQ.App/Resources/Raw/Map/index.html
- src/VenueIQ.App/Controls/MapWebView.xaml.cs
- src/VenueIQ.App/Services/ExportService.cs
- src/VenueIQ.App/Views/MainPage.xaml
- src/VenueIQ.App/Views/MainPage.xaml.cs
- src/VenueIQ.App/Resources/Strings/AppResources.resx
- src/VenueIQ.App/Resources/Strings/AppResources.sr-Latn.resx
- tests/VenueIQ.Tests/Services/ExportServiceTests.cs
## QA Results
